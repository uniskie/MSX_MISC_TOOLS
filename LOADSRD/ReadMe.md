# LOADSRD.BAS

BSAVEされたスクリーンデータと、グラフサウルスのグラフィックデータを表示します。
ファイル名を拡張子まで含めて入力するとファイル名からフォーマットを判断します。
インターレース画像も対応します。

## BSAVEスクリーン画像
VRAMイメージバイナリ。ピクセルデータとパレットデータを含むVRAMイメージ。  
- `BSAVE"ファイル名",開始アドレス,終了アドレス,s`で保存したもの
- `BLOAD"ファイル名",s:color=restore`で表示できる

| 画面モード  | 拡張子  | 説明                                     |
|-------------|---------|------------------------------------------|
| SCREEN5     | SC5     | ピクセル&パレット                        |
|             | S50     | ピクセル&パレット、インターレースページ0 |
|             | S51     | ピクセル&パレット、インターレースページ1 |
| SCREEN7     | SC7     | ピクセル&パレット                        |
|             | S70     | ピクセル&パレット、インターレースページ0 |
|             | S71     | ピクセル&パレット、インターレースページ1 |
| SCREEN8     | SC8     | ピクセル&パレット                        |
|             | S80     | ピクセル&パレット、インターレースページ0 |
|             | S81     | ピクセル&パレット、インターレースページ1 |
| SCREEN10/11 | S10     | ピクセル&パレット                        |
|             | SA0     | ピクセル&パレット、インターレースページ0 |
|             | SA1     | ピクセル&パレット、インターレースページ1 |
| SCREEN12    | S12     | ピクセル&パレット                        |
|             | SC0     | ピクセル&パレット、インターレースページ0 |
|             | SC1     | ピクセル&パレット、インターレースページ1 |

## GRAPH ZAURUS画像
ピクセルデータとパレットデータに分かれている。  
- パレットデータは16色の8バンク切り替えにも対応
- _ランレングス圧縮されたデータにも対応_
- _インターレース画像はファイル名規則不明_

| 画面モード  | 拡張子  | 説明                                     |
|-------------|---------|------------------------------------------|
| SCREEN5     | SR5     | ピクセル(ベタまたはラレングス圧縮)       |
|             | PL5     | ピクセルデータ (16色バンク0～8個)        |
| SCREEN7     | SR7     | ピクセル(ベタまたはラレングス圧縮)       |
|             | PL7     | ピクセルデータ (16色バンク0～8個)        |
| SCREEN8     | SR8     | ピクセル(ベタまたはラレングス圧縮)       |
|             | PL8     | ピクセルデータ (16色バンク0～8個)        |
| SCREEN10/11 | SRA     | ピクセル(ベタまたはラレングス圧縮)       |
|             | PLA     | ピクセルデータ (16色バンク0～8個)        |
| SCREEN12    | SRC     | ピクセル(ベタまたはラレングス圧縮)       |
|             | PLC     | ピクセルデータ (16色バンク0～8個)        |

## ファイル説明

|ファイル     |説明|
|-------------|---
| [HIMEM.BAS  ](HIMEM.BAS  ) | フリーエリア先頭とスタックポインタのアドレスを表示。<br>LOADSRDの機械語プログラムが大きい為、フリーエリアがD500より低ければリセットしてCTRLを押しながら起動するなどしてメモリを開ける必要があります。|
| [LOADER.BAS ](LOADER.BAS ) |アスキーセーブされたLOADSRD.BAS
| [LOADSRD.ASF](LOADSRD.ASF) |機械語プログラムのアセンブラソース(MSX2 SIMPLE ASSEMBLER[^1]用)
| [LOADSRD.ASM](LOADSRD.ASM) |機械語プログラムのアセンブラソース([TNIASM][TNIASM]用)
| [LOADSRD.BAS](LOADSRD.BAS) |グラフィックローダープログラム本体
| [LOADSRD.BOF](LOADSRD.BOF) |グラフィックローダー機械語プログラムバイナリ
| [samples](samples)         |グラフィックデータサンプル

# GRAPH SAURUS 圧縮形式メモ

解析したグラフサウルス圧縮形式のメモになります。

基本はRLE(ランレングス圧縮)ベースになっていて非常に単純です。
グラフサウルス独自の工夫として、カラーコード0番を使用しないことを前提に圧縮効率を高めているようです。

## データマップ

基本はBSAVE形式と同一ですが、ヘッダIDの値が拡張されています。  
ヘッダIDは通常のBSAVEファイルは$FEですが、圧縮ファイルの時は$FDになっています。


|位置 | サイズ  | 内容                                       |
|-----|---------|--------------------------------------------|
|+00  | 1       | ID ( $FE=ベタイメージ / $FD=圧縮イメージ ) |
|+01  | 2       | SA (格納元開始アドレス)                    |
|+03  | 2       | EA (格納元終了アドレス)                    |
|+05  | 2       | RA (実行開始アドレス/画像データでは未使用) |
|+07  | EA-SA+1 | データ本体                                 |

## 圧縮データ

- 1byte単位で処理します。
- SCREEN5～7は4bitカラーなので、2ピクセル単位での処理になります。
- データモードは3つあります。

| 動作名(仮)    | サイズ |  説明
|---------------|--------|------------------------------------------ 
| 直接描画      | 1      | 1byte目が16以上の場合、その値を直接書き込む
| 連続書き込み1 | 2      | 1byte目が1～15の場合、その回数だけ次のbyteの値を書き込む
| 連続書き込み2 | 3      | 1byte目が0の場合、2byteで指定された数だけ、3byte目の値を書き込む

- ピクセル値$00～$0Fが多く点在すると異常に効率が悪くなるものの、
そうでないデータでは、元サイズよりも小さなデータに圧縮されることが期待できます。

- カラー0は透明色扱いであるため、基本的にそのような画像を扱う事は少ないと思います。 
半透明風網掛けパーツなどの場合、連続するので連続書き込みによって圧縮されます。

- 3ドット単位の透明色タイリングで埋め尽くしたデータが最も効率が悪く、ベタデータよりも大きくなると思われます。


[^1]: バックアップ活用テクニック PART16掲載。POCO氏制作 MSX2用「アセンブルシステム」

[TNIASM]: http://www.tni.nl/products/tniasm.html
