## GSRLE

これはBSAVE画像をグラフサウルス圧縮形式で圧縮するものです。

- 圧縮済みデータや、対応していないフォーマットはエラーで中断します。

- **安全の為、扱うファイルはバックアップを取っておきましょう**

- **python版はもうメンテしていません**

### 使い方
gsrle.exeにドロップしてください。
同じフォルダに圧縮後のファイルが出来ます。

- ```GSRLE.exe /s "ファイルパス"``` とすると最後に入力待ちなしで終わります。

- 圧縮後の出力ファイル名は```SR?```や```R??```になります
- BSAVE形式の拡張子と判断した場合はパレットファイル(```*.PL?```)も出力します。
- ※SCREEN8以上の場合はパレットは出力しません。

パレットファイルの有無、画面モードなどは拡張子から判断します。

### コマンドオプション一覧：
```
GRAPH SAURUS like RLE ENCODER

GSRLE [/np][/l][/cp][/256][/212][/s][INPUT FILENAME][/o:OUTPUT FILENAME]

/s      Slient mode. (no input wait)
/bh     Use BSAVE header address range.        (Default : use file size)/cp     Force output size : to palette table.
/212    Force output size : to line 212.
/256    Force output size : to line 256.
/np     No output palette(pl?) file.
/fp     Force output palette(pl?) file
        (at over 256 line data).
/l      Do not overwrite input file.
```

### データサイズの扱い

デフォルトで、データサイズはファイルサイズを元にヘッダ以降をピクセルデータとして扱います。  
**BSAVEヘッダの開始アドレスや終了アドレスはサイズの決定には使用しません。**  

>  **Note**  
> グラフサウルスのベタデータとBSAVEファイルではヘッダに書かれている情報が異なりますが、拡張子以外で区別出来ない為、ヘッダの値が使用する場合、扱うファイルがBSAVEファイルである時に```/bh```オプションで明示的にヘッダを参照するように指定してください。

### パレットファイル出力

256lineデータと判定（または指定）された場合、パレットファイル(```*.PL?```)出力をしません。  
もし、その場合でもパレットファイルを出力したい場合は ```/fp``` オプションを使用してください。

### (おまけ) ```gsrle_all.bat```

> **Warning**  これは危険なものです。

```GSRLE.exe```と```画像の入ったフォルダ```を```gsrle_all.bat```と同じ場所に配置して実行すると、```カレントフォルダ以下のサブフォルダを含めた画像```をすべて一括で変換します。

|   |   |
|---|---|
|gsrle_all.bat | デフォルト動作で一括変換。BSAVEヘッダのサイズに従う。PL?出力あり|
|gsrle_256_all.bat | 強制的に256ライン画像とみなして一括変換。PL?出力なし|

※ **必ず元のファイルはバックアップしておきましょう。**

## BSAVEスクリーン画像

VRAMイメージバイナリ。ピクセルデータとパレットデータを含むVRAMイメージ。  
- `BSAVE"ファイル名",開始アドレス,終了アドレス,s`で保存したもの
- `BLOAD"ファイル名",s:color=restore`で表示できる

### BSAVE 画像 拡張子

| 画面モード  | 拡張子  | 説明                      | 自動インターレース表示[^INTERLACE]|
|-------------|---------|---------------------------|---------------------------|
| SCREEN5     | SC5     | 画素情報 & カラーパレット |                           |
|             | S50     | 画素情報 & カラーパレット | インターレースページ0     |
|             | S51     | 画素情報 & カラーパレット | インターレースページ1     |
| SCREEN6     | SC6     | 画素情報 & カラーパレット |                           |
|             | S60     | 画素情報 & カラーパレット | インターレースページ0     |
|             | S61     | 画素情報 & カラーパレット | インターレースページ1     |
| SCREEN7     | SC7     | 画素情報 & カラーパレット |                           |
|             | S70     | 画素情報 & カラーパレット | インターレースページ0     |
|             | S71     | 画素情報 & カラーパレット | インターレースページ1     |
| SCREEN8     | SC8     | 画素情報のみ              |                           |
|             | S80     | 画素情報のみ              | インターレースページ0     |
|             | S81     | 画素情報のみ              | インターレースページ1     |
| SCREEN10/11 | S10     | 画素情報のみ              |                           |
|             | SRA     | 画素情報のみ              |                           |
|             | SA0     | 画素情報のみ              | インターレースページ0     |
|             | SA1     | 画素情報のみ              | インターレースページ1     |
| SCREEN12    | S12     | 画素情報のみ              |                           |
|             | SC0     | 画素情報のみ              | インターレースページ0     |
|             | SC1     | 画素情報のみ              | インターレースページ1     |

### BSAVE 画像 ヘッダ

| オフセット  | サイズ | 内容         | 補足                                                |
|-------------|--------|--------------|-----------------------------------------------------|
| +0          | 1      | ID           | 値は$FE                                             |
| +1          | 2      | 開始アドレス |                                                     |
| +3          | 2      | 終端アドレス | ピクセルデータサイズは(終端アドレス-開始アドレス+1) |
| +5          | 2      | 開始アドレス | SCREENセーブでは未使用。0に固定0                    |

[^INTERLACE]: 自動インターレース表示される拡張子は個人的な独自仕様。LOADSRDで表示する際にインターレース画像として表示される。


## GRAPH ZAURUS画像

ピクセルデータとパレットデータに分かれている。  
- パレットデータは16色の8トラック(バンク)切り替えに(画像表示中にカーソル左右)
- **データ圧縮**が利用可能 (ランレングス拡張タイプ)

### GRAPH ZAURUS 画像 拡張子

| 画面モード  | 拡張子  | 説明                               | 自動インターレース表示[^INTERLACE]|
|-------------|---------|------------------------------------|---------------------------|
| SCREEN5     | SR5     | 画素情報(ベタまたはラレングス圧縮) |                           |
|             | PL5     | カラーパレット(16色トラック0～8個) |                           |
|             | R50     | 画素情報(ベタまたはラレングス圧縮) | インターレースページ0     |
|             | R51     | 画素情報(ベタまたはラレングス圧縮) | インターレースページ1     |
| SCREEN7     | SR7     | 画素情報(ベタまたはラレングス圧縮) |                           |
|             | PL7     | カラーパレット(16色トラック0～8個) |                           |
|             | R70     | 画素情報(ベタまたはラレングス圧縮) | インターレースページ0     |
|             | R71     | 画素情報(ベタまたはラレングス圧縮) | インターレースページ1     |
| SCREEN8     | SR8     | 画素情報(ベタのみ)                 |                           |
| SCREEN12    | SRS     | 画素情報(ベタのみ)                 |                           |

### GRAPH SAURUS 画像 ヘッダ

| オフセット  | サイズ | 内容         | 補足                                                |
|-------------|--------|--------------|-----------------------------------------------------|
| +0          | 1      | ID           | 値はベタ形式が```$FE```で、圧縮形式が```$FD```      |
| +1          | 2      | 未使用       | 不明。(開始アドレス互換？ 0以外の値は見たことが無い)|
| +3          | 2      | データサイズ | ピクセルデータサイズ(**終了アドレスではない**)      |
| +5          | 2      | 未使用       | 不明。0に固定?                                      |

## GRAPH SAURUS 圧縮形式メモ

解析したグラフサウルス圧縮形式のメモになります。

基本はRLE(ランレングス圧縮)ベースになっていて非常に単純です。
グラフサウルス独自の工夫として、カラーコード0番を使用しないことを前提に圧縮効率を高めているようです。

### データマップ

基本はBSAVE形式と同一ですが、ヘッダIDの値が拡張されています。  

- 無圧縮ベタデータのヘッダIDはBSAVEと同じ```$FE```です。
- 圧縮データの時はヘッダIDは```$FD```です。

| オフセット  | サイズ | 内容         | 補足                                                |
|-------------|--------|--------------|-----------------------------------------------------|
| +0          | 1      | ID           | 値はベタ形式が```$FE```で、圧縮形式が```$FD```      |
| +1          | 2      | 不明         | 不明。(開始アドレス互換？ 0以外の値は見たことが無い)|
| +3          | 2      | データサイズ | ピクセルデータサイズ(**終了アドレスではない**)      |
| +5          | 2      | 不明         | 不明。0が入っている                                 |
| +7          |以降全て| データ本体   | 圧縮またはベタのピクセルデータ                      |

- グラフサウルスにはTILEデータなどもあるのですが、そちらは未確認です。

### 圧縮データ

- 1byte単位で処理します。
- SCREEN5～7は4bitカラーなので、2ピクセル単位での処理になります。
- データモードは3つあります。

| 動作名(仮)    | サイズ |  説明
|---------------|--------|------------------------------------------ 
| 直接描画      | 1      | 1byte目が16以上の場合、その値を直接書き込む
| 連続書き込み1 | 2      | 1byte目が1～15の場合、その回数だけ、2byte目で指定された値を書き込む
| 連続書き込み2 | 3      | 1byte目が0の場合、2byte目で指定された数だけ、3byte目で指定された値を書き込む

- ピクセル値$00～$0Fが多く点在すると異常に効率が悪くなるものの、
そうでないデータでは、元サイズよりも小さなデータに圧縮されることが期待できます。

- カラー0は透明色扱いであるため、基本的にそのような画像を扱う事は少ないと思います。 
半透明風網掛けパーツなどの場合、連続するので連続書き込みによって圧縮されます。

- 3ドット単位の透明色タイリングで埋め尽くしたデータが最も効率が悪く、ベタデータよりも大きくなると思われます。

## 免責事項

プログラムに関して再利用などは自由です。断りもいりません。  
処理は分かりやすさ優先なので、多用したい方はリファクタリングするなどしてください。  

サポートはすごくゆるめです。  
トラブルが発生した場合も当方は責任を持ちません。

## cpp版とpython版

python版はテストで作成したものです。
起動を含めた動作が異様に遅いので、C++で作り直しました。

標準はC++版になります。
